---
title: "vimターミナルモードエスケープと途中で待たないキーバインドとjjの改良"
emoji: "🤪"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [vim,neovim]
published: false
---

```
ターミナルモード
  :term
デフォルトエスケープ
  <c-\><c-n>
キーバインドの例
  <esc><esc>
問題点
```

## TERMINALモード

vim, neovimにはウィンドウでターミナルを開く機能が存在します。

```
:term
```

しかし、初めてvimのTERMINALモードを利用した時に`<ESC>`でNORMALモードに戻ることができず驚いた方もいるのではないかと思います。(自分がそうというやつ)

### エスケープのデフォルトキーバインドはめんどい

vim, neovimのTERMINALモード(TERMINALウインドウでのINSERTモード)からNORMALモードに戻るためのキーバインドは、デフォルトでは次のようになっています。

```
<c-\><c-n>
```

確かにこんなマッピングなら、ターミナル内のアプリケーションと衝突することもそうそうないでしょう。しかし、2ストローク必要で、キー自体そこそこ押しにくいので、めんどいです。できれば普通のバッファと同じく`<ESC>`でNORMALに戻りたいものです。

### 脳死で`<ESC>`でNORMALに抜けるようにするとターミナル内のアプリケーションに`<ESC>`が渡せない

```
tnoremap <ESC> <c-\><c-n>
```

を設定すると、`<ESC>`を打ってNORMALに戻れるようになります。

しかし、`<ESC>`を打ってもvim側がNORMALに戻るキーバインドとして処理してしまうので、アプリケーション側に`<ESC>`を渡せなくなります。

TERMINALからNORMALに抜けるキーバインドには、押しやすさだけではなく、競合しにくさも求められるので、少し工夫が必要になります。

### NORMALに戻るのを`<ESC>`2回押しにしてみる

```
tnoremap <ESC><ESC> <c-\><c-n>
```

`<ESC>`2回押しでNORMALに抜ける設定にすれば、1回押しをターミナル内のアプリケーション用に残すことができます。
つまり、

- `<ESC>` 1回押し → TERMINAL内のアプリケーションに `<ESC>` を渡す
- `<ESC>` 2回押し → NORMALに戻る

と打ち分ける方式です。

これでOKに見えますが、残念ながら1回押しの時点では入力が確定しないという問題があります。

`<ESC>`を1回押しただけの段階では、その入力が`<ESC><ESC>`の一部なのか、`<ESC>`1回で終わるつもりなのかvimからすると判別できません。そのため、`<ESC>`1回押しの操作はデフォルトで1秒待つか別のキー入力があるまで確定されません。

ちなみにこの「別のキー入力」は、入力後に`<ESC>`とまとめて2ストローク送られるので、なんでもいいという訳ではなく、`<ESC>`の後に入力する予定のキーを打つ必要があります。

ただし、当然ながら入力の確定待ちの内は画面が動かないわけなので、自分がサクサク操作していた所に異質なつっかかりが発生することになり、わかっていても結構難しいです。

あと1秒の待ち時間もクロノスタシスっぽい感じでちょっと長く感じます。

## `<Plug>()`のハック

しばらく前、[vim-jp Slack](https://vim-jp.org/docs/chat.html)でこんな技が紹介されていました。

![](https://github.com/fuzmare/zenn-articles/blob/main/articles/vim-term-escape/plug.png?raw=true)

# こないだ思いついたやつ

ようやく本題、私が先日思い付いたのがこのようなマッピングです。

```
tnoremap <ESC> <c-\><c-n><Plug>(esc)
nnoremap <Plug>(esc)<ESC> i<ESC>
```

このキーバインドでは、ESCを押すと即座にNORMALに行き、続けてESCを入れるとTERMINALに戻り、TERMINAL側にESCが渡るようになっています。

- `<ESC>` 1回押し → 押してすぐ、**待たずに**NORMALに行く
- `<ESC>` 2回押し → TERMINALに戻ってアプリケーションの方に `<ESC>` を渡す

`<ESC>`2回押しのキーバインドの始まりを実質仮想キーの`<Plug>`にすり替えてやることで、`<ESC>`で始まるキーバインドは一つしかなくなり、1回押された段階でNORMAL戻りが発火するようにできます。(`<Plug>`は物理的なキー入力にはマッチしないマップを作成するものです。)

